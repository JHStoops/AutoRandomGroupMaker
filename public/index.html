<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Auto Random Group Maker</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
</head>

<body>
    <div id="app">
        <div class="row">
            <div class="col-xs-8 offset-xl-2">
                <!-- Create a random group -->
                <button @click="createRandomGroup(3)">Create Random Group</button>
                <br><br>

                <!-- New Groups -->
                <div v-if="newGroups.length > 0">
                    <h2>New Groups</h2>
                    <div class="row">
                        <div class="card col-3" v-for="group of newGroups">
                            <div class="card-block">
                                <h4 class="card-title">Milestone #{{ group.milestone }}</h4>
                                <h6 class="card-subtitle">Members:</h6>
                                <p class="card-text" v-for="member of group.members">{{  uvidToName(member) }}</p>
                            </div>
                        </div>
                    </div>
                    <button @click="confirmNewGroups()">Confirm New Groups</button>
                    <br>
                </div>

                <!-- Current Group -->
                <h2>Current Groups</h2>
                <div class="row">
                    <div class="card col-3" v-for="group of previousGroups" v-if="group.milestone == currentMilestone">
                        <div class="card-block">
                            <h4 class="card-title">Milestone #{{ group.milestone }}</h4>
                            <h6 class="card-subtitle">Members:</h6>
                            <p class="card-text" v-for="member of group.members">{{  uvidToName(member) }}</p>
                        </div>
                    </div>
                </div>
                <br>

                <!-- Previous Groups -->
                <h2>Previous Groups</h2>
                <div class="row">
                    <div class="card col-3" v-for="group of previousGroups" v-if="group.milestone < currentMilestone">
                        <div class="card-block">
                            <h4 class="card-title">Milestone #{{ group.milestone }}</h4>
                            <h6 class="card-subtitle">Members:</h6>
                            <p class="card-text" v-for="member of group.members">{{  uvidToName(member) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* global Vue */
        /* global axios */
        let app = new Vue({
            el: '#app',
            data: {
                students: new Map(),
                previousGroups: [],
                newGroups: [],
                currentMilestone: null
            },
            methods: {
                uvidToName: function(UVID){
                    return this.students.get(String(UVID));
                },
                confirmNewGroups: function(){
                    //Post groups to the database
                    for (group of this.newGroups){
                        axios.post('http://localhost:3000/previousGroups', {
                            "milestone": group.milestone,
                            "members": group.members
                        })
                            .then(function(res){    console.log(res); })
                            .catch(function(err){   console.log(err); });
                    }

                    //move groups from newGroups into previousGroups and clear out newGroups
                    this.previousGroups = this.previousGroups.concat(this.newGroups);
                    this.currentMilestone = this.newGroups[0].milestone;
                    this.newGroups = [];
                },
                createRandomGroup: function(groupSize){
                    //FIXME Don't hardcode the groupSize -- use select/options elements.
                    let newGroup = {};
                    newGroup.milestone = this.currentMilestone + 1;
                    newGroup.members = [];
                    let studs = Array.from(this.students).map((stud) => Number(stud[0])); //Array of UVIDs
                    let stud = null;

                    //pull a student out of this map when placing them in groups
                    while (studs.length > 0) {
                        //take random student from array
                        stud = (studs.splice(Math.floor(Math.random() * studs.length), 1))[0];
                        newGroup.members.push(stud);

                        //Create a map container of classmates and amount of times in group with them.
                        let previousStuds = [];
                        app.previousGroups.forEach(function (group) {
                            if (group.members.includes(stud)) {
                                group.members.forEach(function (mem) {
                                    previousStuds.push(mem)
                                })
                            }
                        });

                        //Group with randomized selection from remaining students IFF they haven't been grouped together.
                        //FIXME runs in eternal loop if the last few students have been in the same group before.
                        //TODO put in logic to determine special group sizes based on groupSize and remaining students, e.g. groupSize=3, remaining students=4
                        //TODO introduce logic to group students together if they've been in groups with all remaining students.
                        for (let i = groupSize; i > 1;) {
                            if (studs.length === 0) break;
                            let randomIndex = Math.floor(Math.random() * studs.length);

                            //Check if stud has already been in the same group as potentialStud
                            if (previousStuds.includes(studs[randomIndex])) continue;
                            i--;
                            newGroup.members.push((studs.splice(randomIndex, 1))[0]);
                        }

                        //Save new group to the suggestedGroups array
                        this.newGroups.push(Object.assign({}, newGroup));   // Push a hard copy
                        newGroup.members = [];
                    }
                }
            },
            created: function(){
                let self = this;    //closure - captures the scope of all the variables of 'this' which is the 'created' function.

                //Grab Students
                axios.get('http://localhost:3000/students')
                    .then(function(res){
                        res.data.forEach((student) => self.students.set(student.UVID, student.name));
                    })
                    .catch(function(err){
                        console.log(err);
                    });

                //Grab previous groups
                axios.get('http://localhost:3000/previousGroups')
                    .then(function(res){
                        self.previousGroups = res.data;
                        self.previousGroups.forEach(function(x){
                            if (self.currentMilestone === null || self.currentMilestone < x.milestone) self.currentMilestone = x.milestone;
                        });
                    })
                    .catch(function(err){
                        console.log(err);
                    });
            }
        });
    </script>
</body>

</html>
